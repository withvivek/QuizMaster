<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - QuizMaster</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e8f0ff, #f0f5ff);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }
    .navbar {
      background: linear-gradient(90deg, #004aad, #007bff);
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    .table-hover tbody tr:hover {
      background-color: #e7f1ff;
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-dark px-4 mb-4">
  <span class="navbar-brand mb-0 h1 text-white">QuizMaster Admin Dashboard</span>
  <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container">
  <h3 class="text-center text-primary fw-semibold mb-4">Manage Quiz Questions</h3>

  <!-- Add Question Form -->
  <div class="card p-4 mb-5">
    <h5 class="fw-semibold text-success mb-3">Add New Question</h5>
    <form id="addQuestionForm" onsubmit="addQuestion(event)">
      <div class="row g-3">
        <div class="col-md-12">
          <input type="text" class="form-control" id="questiontitle" placeholder="Question Title" required>
        </div>
        <div class="col-md-6"><input type="text" class="form-control" id="option1" placeholder="Option 1" required></div>
        <div class="col-md-6"><input type="text" class="form-control" id="option2" placeholder="Option 2" required></div>
        <div class="col-md-6"><input type="text" class="form-control" id="option3" placeholder="Option 3" required></div>
        <div class="col-md-6"><input type="text" class="form-control" id="option4" placeholder="Option 4" required></div>
        <div class="col-md-4"><input type="text" class="form-control" id="rightAnswer" placeholder="Right Answer" required></div>
        <div class="col-md-4"><input type="text" class="form-control" id="difficultylevel" placeholder="Difficulty Level" required></div>
        <div class="col-md-4"><input type="text" class="form-control" id="category" placeholder="Category" required></div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">Add Question</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Questions Table -->
  <div class="card p-4">
    <h5 class="fw-semibold text-primary mb-3">All Questions</h5>
    <table class="table table-bordered table-hover">
      <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Question</th>
        <th>Category</th>
        <th>Level</th>
        <th>Answer</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody id="questionTable"></tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editForm" onsubmit="updateQuestion(event)">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Edit Question</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <input type="hidden" id="editId">
          <div class="col-md-12">
            <label class="form-label">Question Title</label>
            <input type="text" class="form-control" id="editTitle" required>
          </div>
          <div class="col-md-6"><input type="text" id="editOpt1" class="form-control" placeholder="Option 1" required></div>
          <div class="col-md-6"><input type="text" id="editOpt2" class="form-control" placeholder="Option 2" required></div>
          <div class="col-md-6"><input type="text" id="editOpt3" class="form-control" placeholder="Option 3" required></div>
          <div class="col-md-6"><input type="text" id="editOpt4" class="form-control" placeholder="Option 4" required></div>
          <div class="col-md-4"><input type="text" id="editRight" class="form-control" placeholder="Right Answer" required></div>
          <div class="col-md-4"><input type="text" id="editLevel" class="form-control" placeholder="Difficulty Level" required></div>
          <div class="col-md-4"><input type="text" id="editCategory" class="form-control" placeholder="Category" required></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = "http://localhost:80/api/admin";
  let editModal;

  document.addEventListener('DOMContentLoaded', () => {
    const role = localStorage.getItem('role');
    const user = localStorage.getItem('username');
    if (!user || role !== 'ADMIN') {
      alert("Access denied!");
      window.location.href = 'login.html';
      return;
    }
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    loadQuestions();
  });

  async function loadQuestions() {
    const res = await fetch(`${API_BASE}/questions`);
    const data = await res.json();
    const table = document.getElementById('questionTable');
    table.innerHTML = '';
    data.forEach(q => {
      table.innerHTML += `
        <tr>
          <td>${q.id}</td>
          <td>${q.questiontitle}</td>
          <td>${q.category}</td>
          <td>${q.difficultylevel}</td>
          <td>${q.rightAnswer}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick='openEdit(${q.id})'>
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>`;
    });
  }

  async function addQuestion(event) {
        event.preventDefault();
        const q = {
          questiontitle: questiontitle.value,
          option1: option1.value,
          option2: option2.value,
          option3: option3.value,
          option4: option4.value,
          rightAnswer: rightAnswer.value,
          difficultylevel: difficultylevel.value,
          category: category.value
        };

        try {
          const res = await fetch(`${API_BASE}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(q)
          });
          const text = await res.text();
          if (res.ok) {
            alert("✅ Question added!");
            addQuestionForm.reset();
            loadQuestions();
          } else {
            alert("❌ Error: " + text);
          }
        } catch (err) {
          console.error(err);
          alert("❌ Network error: " + err.message);
        }
      }

  async function openEdit(id) {
        const res = await fetch(`${API_BASE}/questions`);
        const all = await res.json();
        const q = all.find(x => x.id === id);
        if (!q) return alert("Question not found!");

        editId.value = q.id;
        editTitle.value = q.questiontitle;
        editOpt1.value = q.option1;
        editOpt2.value = q.option2;
        editOpt3.value = q.option3;
        editOpt4.value = q.option4;
        editRight.value = q.rightAnswer;
        editLevel.value = q.difficultylevel;
        editCategory.value = q.category;
        editModal.show();
      }


  async function updateQuestion(event) {
    event.preventDefault();
    const id = editId.value;
    const updated = {
      questiontitle: editTitle.value,
      option1: editOpt1.value,
      option2: editOpt2.value,
      option3: editOpt3.value,
      option4: editOpt4.value,
      rightAnswer: editRight.value,
      difficultylevel: editLevel.value,
      category: editCategory.value
    };
    const res = await fetch(`${API_BASE}/update/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updated)
    });
    if (res.ok) {
      alert("✅ Question updated!");
      editModal.hide();
      loadQuestions();
    }
  }

  async function deleteQuestion(id) {
    if (!confirm("Delete this question?")) return;
    const res = await fetch(`${API_BASE}/delete/${id}`, { method: 'DELETE' });
    if (res.ok) {
      alert("✅ Deleted!");
      loadQuestions();
    }
  }

  function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
  }
</script>
</body>
</html>